<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEON PMS - Calendar Operations</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/shared.css" rel="stylesheet">
    <style>
        /* Calendar Specific Styles */
        .calendar-container {
            padding: 20px;
            max-width: 100%;
            overflow-x: auto;
        }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            flex-wrap: wrap;
            gap: 15px;
        }

        .date-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-btn {
            background: #FF6842;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }

        .nav-btn:hover {
            background: #e55a3a;
        }

        .current-period {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            min-width: 200px;
        }

        .view-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .view-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .view-btn.active {
            background: #FF6842;
            color: white;
            border-color: #FF6842;
        }

        .view-btn:hover {
            border-color: #FF6842;
        }

        /* Calendar Grid */
        .calendar-grid {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
            min-width: 1200px;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: 250px repeat(7, 1fr);
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .calendar-header div {
            padding: 15px 10px;
            text-align: center;
            border-right: 1px solid #e0e0e0;
        }

        .calendar-header .room-header {
            text-align: left;
            padding-left: 20px;
            background: #FF6842;
            color: white;
        }

        .date-header {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .date-number {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .date-day {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 2px;
        }

        .date-full {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-top: 1px;
        }

        /* Calendar Body */
        .calendar-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .room-row {
            display: grid;
            grid-template-columns: 250px repeat(7, 1fr);
            border-bottom: 1px solid #e0e0e0;
            min-height: 80px;
            transition: background 0.2s;
        }

        .room-row:hover {
            background: #f8f9fa;
        }

        .room-info {
            padding: 15px 20px;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: #fafafa;
        }

        .room-number {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
        }

        .room-type {
            font-size: 0.85rem;
            color: #666;
            margin-top: 2px;
        }

        .room-status {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
            margin-top: 6px;
            display: inline-block;
            max-width: fit-content;
            font-weight: 500;
        }

        /* Cleanliness-based statuses only */
        .status-CLEAN { background: #d4edda; color: #155724; }
        .status-DIRTY { background: #fff3cd; color: #856404; }
        .status-MAINTENANCE { background: #e2e3e5; color: #383d41; }
        .status-OUT_OF_ORDER { background: #f5c6cb; color: #721c24; }
        
        /* Legacy support during transition */
        .status-CLEAN_VACANT { background: #d4edda; color: #155724; }
        .status-DIRTY_VACANT { background: #fff3cd; color: #856404; }

        /* Date Cells */
        .date-cell {
            border-right: 1px solid #e0e0e0;
            padding: 5px;
            position: relative;
            min-height: 80px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .date-cell:hover {
            background: #f0f8ff;
        }

        /* Simplified occupancy-based colors */
        .date-cell.available {
            background: #f8fff8; /* Light green - available for booking */
        }

        .date-cell.occupied {
            background: #fff5f5; /* Light red - has booking */
        }

        /* Special cases for maintenance/out of order */
        .date-cell.unavailable {
            background: #f8f8f8; /* Gray - maintenance/out of order */
        }

        .date-cell.drag-over {
            background: #e3f2fd !important;
            border: 2px dashed #2196f3 !important;
        }

        /* Booking Blocks */
        .booking-block {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 6px 8px;
            margin: 1px 0;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: move;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transition: all 0.3s;
            min-height: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .booking-block:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .booking-block.confirmed {
            background: linear-gradient(135deg, #007bff, #0056b3);
        }

        .booking-block.checked-in {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }

        .booking-block.pending {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }

        .booking-block.dragging {
            opacity: 0.6;
            transform: rotate(2deg);
        }

        .booking-guest {
            font-weight: 600;
            font-size: 0.85rem;
            line-height: 1.2;
        }

        .booking-details {
            font-size: 0.7rem;
            opacity: 0.9;
            margin-top: 1px;
            line-height: 1.1;
        }

        /* Unassigned Bookings Sidebar */
        .unassigned-sidebar {
            position: fixed;
            right: -350px;
            top: 0;
            width: 350px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .unassigned-sidebar.open {
            right: 0;
        }

        .sidebar-header {
            background: #FF6842;
            color: white;
            padding: 20px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .sidebar-content {
            padding: 0;
        }

        .unassigned-booking {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            cursor: move;
            transition: background 0.2s;
            background: white;
        }

        .unassigned-booking:hover {
            background: #f8f9fa;
        }

        .unassigned-booking.dragging {
            opacity: 0.5;
        }

        .assigned-booking {
            background: #f0f8ff;
            border-left: 4px solid #28a745;
        }

        .assigned-booking:hover {
            background: #e8f4f8;
        }

        .unassigned-guest {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .unassigned-dates {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 2px;
        }

        .unassigned-room-type {
            font-size: 0.8rem;
            color: #888;
        }

        /* Toggle Button */
        .sidebar-toggle {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: #FF6842;
            color: white;
            border: none;
            padding: 15px 12px;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            font-weight: 600;
            z-index: 999;
            transition: all 0.3s;
            box-shadow: -2px 0 8px rgba(0,0,0,0.2);
        }

        .sidebar-toggle:hover {
            background: #e55a3a;
            padding-right: 18px;
        }

        .sidebar-toggle.active {
            right: 350px;
        }

        /* Status Legend */
        .status-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FF6842;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }

        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.info { background: #007bff; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 20px 10px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: #666;
            transition: color 0.3s;
        }

        .close:hover {
            color: #FF6842;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #FF6842;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-primary {
            background: #FF6842;
            color: white;
        }

        .btn-primary:hover {
            background: #e55a3a;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .calendar-grid {
                min-width: 1000px;
            }
            .calendar-header {
                grid-template-columns: 200px repeat(7, 1fr);
            }
            .room-row {
                grid-template-columns: 200px repeat(7, 1fr);
            }
        }

        @media (max-width: 768px) {
            .calendar-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .date-navigation {
                justify-content: space-between;
            }
            
            .view-controls {
                justify-content: center;
            }
            
            .unassigned-sidebar {
                width: 100%;
                right: -100%;
            }
            
            .sidebar-toggle.active {
                right: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="logo">
                <i class="fas fa-hotel"></i> LEON PMS
            </a>
            
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="index.html" class="nav-link" data-page="dashboard">
                            <i class="nav-icon fas fa-home"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="operations.html" class="nav-link" data-page="operations">
                            <i class="nav-icon fas fa-tasks"></i>
                            Operations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="inventory.html" class="nav-link" data-page="inventory">
                            <i class="nav-icon fas fa-calendar-alt"></i>
                            Inventory
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="bookings.html" class="nav-link" data-page="bookings">
                            <i class="nav-icon fas fa-book"></i>
                            Bookings
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="rooms.html" class="nav-link" data-page="rooms">
                            <i class="nav-icon fas fa-bed"></i>
                            Room Types
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="analytics.html" class="nav-link" data-page="analytics">  
                            <i class="nav-icon fas fa-chart-bar"></i>
                            Analytics
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="user-info">
                <i class="fas fa-user-circle"></i> Property Manager
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">Calendar Operations</h1>
                <p class="page-subtitle">Drag and drop bookings to assign rooms</p>
            </div>

            <!-- Calendar Container -->
            <div class="calendar-container">
                <!-- Calendar Controls -->
                <div class="calendar-controls">
                    <div class="date-navigation">
                        <button class="nav-btn" onclick="navigateWeek(-1)">
                            <i class="fas fa-chevron-left"></i> Previous Week
                        </button>
                        <div class="current-period" id="currentPeriod">Loading...</div>
                        <button class="nav-btn" onclick="navigateWeek(1)">
                            Next Week <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="view-controls">
                        <button class="view-btn active" onclick="setView('week')">Week View</button>
                        <button class="view-btn" onclick="setView('month')">Month View</button>
                        <button class="view-btn" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Status Legend -->
                <div class="status-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f8fff8;"></div>
                        <span>Available (no booking)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fff5f5;"></div>
                        <span>Occupied (has booking)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f8f8f8;"></div>
                        <span>Unavailable (maintenance/out of order)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #d4edda;"></div>
                        <span>Room: Clean</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fff3cd;"></div>
                        <span>Room: Needs Housekeeping</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e2e3e5;"></div>
                        <span>Room: Under Maintenance</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #007bff;"></div>
                        <span>Confirmed Booking</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #28a745;"></div>
                        <span>Checked-in Guest</span>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div class="calendar-grid">
                    <!-- Calendar Header -->
                    <div class="calendar-header" id="calendarHeader">
                        <div class="room-header">Rooms</div>
                        <!-- Date headers will be populated by JavaScript -->
                    </div>

                    <!-- Calendar Body -->
                    <div class="calendar-body" id="calendarBody">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading calendar data...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Unassigned Bookings Sidebar -->
    <div class="unassigned-sidebar" id="unassignedSidebar">
        <div class="sidebar-header">
            <i class="fas fa-list-alt"></i> Unassigned Bookings
        </div>
        <div class="sidebar-content" id="sidebarContent">
            <div class="loading">
                <div class="spinner"></div>
                Loading bookings...
            </div>
        </div>
    </div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
        <i class="fas fa-list"></i> Bookings
    </button>

    <!-- Edit Booking Modal -->
    <div id="editBookingModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Booking Dates</h3>
                <span class="close" onclick="closeEditBookingModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Guest Name:</label>
                    <input type="text" id="editGuestName" required>
                </div>
                <div class="form-group">
                    <label>Check-in Date:</label>
                    <input type="date" id="editCheckinDate">
                </div>
                <div class="form-group">
                    <label>Check-out Date:</label>
                    <input type="date" id="editCheckoutDate">
                </div>
                <div class="form-group">
                    <label>Reason for Date Change:</label>
                    <textarea id="editBookingNotes" placeholder="Optional notes about the date change..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditBookingModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmBookingEdit()">Update Booking & Assign Room</button>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/navigation.js"></script>
    <script>
        // Global variables
        let currentWeekStart = new Date();
        let currentView = 'week';
        let allRooms = [];
        let allBookings = [];
        let draggedBooking = null;
        let pendingAssignment = null; // For date change handling

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize API client with selected hotel from localStorage
            const savedHotel = localStorage.getItem('selectedHotel');
            if (savedHotel) {
                const hotel = JSON.parse(savedHotel);
                api.setSelectedHotel(hotel.property_id);
            }
            
            // Set current week start to Monday
            setWeekStart();
            updateCalendarDisplay();
            loadCalendarData();
        });

        // Set week start to Monday
        function setWeekStart() {
            const today = new Date();
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
            currentWeekStart = new Date(today.setDate(diff));
        }

        // Navigation Functions
        function navigateWeek(direction) {
            const newDate = new Date(currentWeekStart);
            newDate.setDate(newDate.getDate() + (direction * 7));
            currentWeekStart = newDate;
            updateCalendarDisplay();
            loadCalendarData();
        }

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateCalendarDisplay();
            loadCalendarData();
        }

        function updateCalendarDisplay() {
            const endDate = new Date(currentWeekStart);
            endDate.setDate(endDate.getDate() + 6);
            
            const options = { month: 'long', day: 'numeric', year: 'numeric' };
            const startStr = currentWeekStart.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
            const endStr = endDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
            
            document.getElementById('currentPeriod').textContent = 
                `${startStr} - ${endStr}, ${currentWeekStart.getFullYear()}`;
            
            updateCalendarHeader();
        }

        function updateCalendarHeader() {
            const header = document.getElementById('calendarHeader');
            const dates = [];
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                dates.push(date);
            }
            
            header.innerHTML = `
                <div class="room-header">Rooms</div>
                ${dates.map(date => `
                    <div class="date-header">
                        <div class="date-number">${date.getDate()}</div>
                        <div class="date-day">${date.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase()}</div>
                        <div class="date-full">${date.toLocaleDateString('en-US', { month: 'short' })}</div>
                    </div>
                `).join('')}
            `;
        }

        // Data Loading Functions
        async function loadCalendarData() {
            try {
                showLoading();
                
                // Load rooms and bookings in parallel
                await Promise.all([
                    loadRooms(),
                    loadBookings()
                ]);
                
                renderCalendar();
                renderUnassignedBookings();
                
            } catch (error) {
                console.error('Error loading calendar data:', error);
                showNotification('Error loading calendar data', 'error');
            }
        }

        async function loadRooms() {
            try {
                const response = await api.getRooms();
                if (response.success) {
                    allRooms = response.rooms.sort((a, b) => {
                        if (a.floor !== b.floor) return a.floor - b.floor;
                        return a.room_number.localeCompare(b.room_number);
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }

        async function loadBookings() {
            try {
                // Clear existing bookings to force fresh load
                allBookings = [];
                
                // Load both bookings and room assignments
                const [bookingsResponse, assignmentsResponse] = await Promise.all([
                    api.getBookings().catch(e => ({ bookings: [] })),
                    api.getRoomAssignments().catch(e => ({ assignments: [] }))
                ]);
                
                const bookings = bookingsResponse || [];
                const allAssignments = assignmentsResponse?.assignments || [];
                
                // Filter to only include active assignments (not cancelled)
                const activeAssignments = allAssignments.filter(assignment => 
                    assignment.assignment_status === 'ASSIGNED' || 
                    assignment.assignment_status === 'CHECKED_IN'
                );
                
                console.log('Loaded bookings:', bookings.length, 'total assignments:', allAssignments.length, 'active assignments:', activeAssignments.length);
                console.log('Sample active assignment:', activeAssignments[0]);
                console.log('Sample booking data:', bookings[0]);
                
                // Merge bookings and assignments into unified format
                allBookings = [
                    ...bookings,
                    ...activeAssignments.map(assignment => ({
                        id: assignment.booking_id,
                        booking_id: assignment.booking_id,
                        room_id: assignment.room_id,
                        guest_name: assignment.guest_name,
                        checkin_date: assignment.check_in_date,
                        checkout_date: assignment.check_out_date,
                        check_in_date: assignment.check_in_date,
                        check_out_date: assignment.check_out_date,
                        status: assignment.assignment_status || 'ASSIGNED',
                        booking_status: assignment.assignment_status || 'ASSIGNED',
                        assignment_status: assignment.assignment_status
                    }))
                ];
                
                // Remove duplicates (booking might appear in both lists)
                const uniqueBookings = new Map();
                allBookings.forEach(booking => {
                    const key = booking.id || booking.booking_id;
                    const existing = uniqueBookings.get(key);
                    
                    // Prefer entries with room_id (assigned bookings) or more recent data
                    if (!existing || booking.room_id || (existing && !existing.room_id)) {
                        uniqueBookings.set(key, booking);
                    }
                });
                
                allBookings = Array.from(uniqueBookings.values());
                console.log('Final merged bookings:', allBookings.length);
                
                // Debug: log all bookings with room assignments
                allBookings.forEach(booking => {
                    if (booking.room_id) {
                        console.log(`Booking ${booking.guest_name}: room_id=${booking.room_id}, checkin=${booking.checkin_date || booking.check_in_date}`);
                    }
                });
                
            } catch (error) {
                console.error('Error loading bookings:', error);
                allBookings = [];
            }
        }

        function renderCalendar() {
            const calendarBody = document.getElementById('calendarBody');
            const dates = [];
            
            // Generate week dates
            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                dates.push(date);
            }
            
            calendarBody.innerHTML = allRooms.map(room => `
                <div class="room-row" data-room-id="${room.room_id}">
                    <div class="room-info">
                        <div class="room-number">${room.room_number}</div>
                        <div class="room-type">${room.room_name || 'Standard'}</div>
                        <div class="room-status status-${getRoomCleanlinessStatus(room)}">${getRoomCleanlinessStatus(room)}</div>
                    </div>
                    ${dates.map(date => {
                        const dateStr = formatDate(date);
                        const booking = findBookingForRoomAndDate(room.room_id, dateStr);
                        const occupancy = getRoomOccupancyForDate(room, dateStr);
                        
                        // Debug logging for booking assignment issues
                        if (room.room_number === '1003' || room.room_number === '1005') {
                            console.log(`Room ${room.room_number} on ${dateStr}: booking =`, booking?.guest_name || 'none', 'occupancy =', occupancy);
                        }
                        
                        return `
                            <div class="date-cell ${getDateCellClass(room, dateStr)}" 
                                 data-room-id="${room.room_id}" 
                                 data-date="${dateStr}"
                                 ondrop="dropBooking(event)" 
                                 ondragover="allowDrop(event)"
                                 ondragleave="dragLeave(event)"
                                 title="Room ${room.room_number} - ${occupancy}">
                                ${booking ? renderBookingBlock(booking, dateStr) : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `).join('');
        }

        function findBookingForRoomAndDate(roomId, date) {
            const booking = allBookings.find(booking => {
                if (booking.room_id !== roomId) return false;
                
                // Handle both assigned bookings (with room_id) and room assignments
                const checkinDate = booking.checkin_date || booking.check_in_date;
                const checkoutDate = booking.checkout_date || booking.check_out_date;
                
                if (!checkinDate || !checkoutDate) return false;
                
                // Check if date falls within the booking period (inclusive of checkin, exclusive of checkout)
                const isInRange = date >= checkinDate && date < checkoutDate;
                
                return isInRange;
            });
            
            // Debug logging when looking for specific rooms
            if ((roomId && roomId.includes('1003')) || (roomId && roomId.includes('1005'))) {
                console.log(`findBookingForRoomAndDate(${roomId}, ${date}): found booking =`, booking?.guest_name || 'none');
            }
            
            return booking;
        }

        function getRoomCleanlinessStatus(room) {
            // Get current cleanliness status (today's physical state)
            return room.cleanliness_status || extractCleanlinessFromStatus(room.room_status);
        }

        function getRoomOccupancyForDate(room, date) {
            const booking = findBookingForRoomAndDate(room.room_id, date);
            
            if (booking) {
                // Check if guest is checked in or just reserved
                const status = booking.status || booking.booking_status || booking.assignment_status;
                return status === 'CHECKED_IN' ? 'OCCUPIED' : 'RESERVED';
            }
            
            return 'VACANT';
        }

        function extractCleanlinessFromStatus(roomStatus) {
            // Extract cleanliness from legacy combined status
            if (roomStatus === 'CLEAN_VACANT') return 'CLEAN';
            if (roomStatus === 'DIRTY_VACANT') return 'DIRTY';
            if (roomStatus === 'MAINTENANCE') return 'MAINTENANCE';
            if (roomStatus === 'OUT_OF_ORDER') return 'OUT_OF_ORDER';
            return 'CLEAN'; // Default
        }

        function getDateCellClass(room, date) {
            const occupancy = getRoomOccupancyForDate(room, date);
            const cleanliness = getRoomCleanlinessStatus(room);
            
            // Check if room is unavailable due to maintenance/out of order
            if (cleanliness === 'MAINTENANCE' || cleanliness === 'OUT_OF_ORDER') {
                return 'unavailable';
            }
            
            // Show based on occupancy
            if (occupancy === 'VACANT') {
                return 'available';
            } else {
                return 'occupied'; // RESERVED or OCCUPIED
            }
        }

        function renderBookingBlock(booking, date) {
            // Handle both booking formats
            const checkinDate = booking.checkin_date || booking.check_in_date;
            const checkoutDate = booking.checkout_date || booking.check_out_date;
            const guestName = booking.guest_name;
            const status = booking.status || booking.booking_status || 'CONFIRMED';
            const bookingId = booking.id || booking.booking_id;
            
            const isStart = date === checkinDate;
            const isEnd = date === getDateBefore(checkoutDate);
            const totalNights = Math.ceil((new Date(checkoutDate) - new Date(checkinDate)) / (1000 * 60 * 60 * 24));
            const currentNight = Math.floor((new Date(date) - new Date(checkinDate)) / (1000 * 60 * 60 * 24)) + 1;
            
            let blockClass = 'booking-block';
            if (status.toLowerCase() === 'confirmed') blockClass += ' confirmed';
            else if (status.toLowerCase() === 'checked_in') blockClass += ' checked-in';
            else if (status.toLowerCase() === 'pending') blockClass += ' pending';
            
            return `
                <div class="${blockClass}" 
                     draggable="true" 
                     ondragstart="dragBooking(event)" 
                     data-booking-id="${bookingId}">
                    <div class="booking-guest">${guestName}</div>
                    <div class="booking-details">
                        ${isStart ? `${totalNights} night${totalNights !== 1 ? 's' : ''}` : 
                          isEnd ? 'Check-out' : `Night ${currentNight}`}
                    </div>
                </div>
            `;
        }

        function renderUnassignedBookings() {
            const sidebarContent = document.getElementById('sidebarContent');
            
            // Show both unassigned bookings and assigned bookings (for reassignment)
            const unassignedBookings = allBookings.filter(booking => {
                const status = booking.status || booking.booking_status;
                return !booking.room_id && (status === 'CONFIRMED' || status === 'PENDING');
            });
            
            const assignedBookings = allBookings.filter(booking => {
                const status = booking.status || booking.booking_status || booking.assignment_status;
                return booking.room_id && (status === 'ASSIGNED' || status === 'CHECKED_IN' || status === 'CONFIRMED');
            });
            
            const allMovableBookings = [...unassignedBookings, ...assignedBookings];
            
            if (allMovableBookings.length === 0) {
                sidebarContent.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666;">
                        <i class="fas fa-calendar-check" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>No bookings to move!</p>
                    </div>
                `;
                return;
            }
            
            // Create sections for unassigned and assigned bookings
            let sidebarHTML = '';
            
            if (unassignedBookings.length > 0) {
                sidebarHTML += `
                    <div style="padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; font-weight: 600; color: #FF6842;">
                        <i class="fas fa-exclamation-circle"></i> Unassigned Bookings (${unassignedBookings.length})
                    </div>
                `;
                sidebarHTML += unassignedBookings.map(booking => renderBookingSidebarItem(booking, false)).join('');
            }
            
            if (assignedBookings.length > 0) {
                sidebarHTML += `
                    <div style="padding: 15px 20px; background: #e8f5e8; border-bottom: 1px solid #e0e0e0; font-weight: 600; color: #28a745;">
                        <i class="fas fa-bed"></i> Assigned Bookings (${assignedBookings.length})
                    </div>
                `;
                sidebarHTML += assignedBookings.map(booking => renderBookingSidebarItem(booking, true)).join('');
            }
            
            sidebarContent.innerHTML = sidebarHTML;
        }
        
        function renderBookingSidebarItem(booking, isAssigned) {
            const checkinDate = booking.checkin_date || booking.check_in_date;
            const checkoutDate = booking.checkout_date || booking.check_out_date;
            const guestCount = booking.guests || booking.rooms_booked || 1;
            const bookingId = booking.id || booking.booking_id;
            const currentRoom = isAssigned ? getRoomNumber(booking.room_id) : null;
            
            return `
                <div class="unassigned-booking ${isAssigned ? 'assigned-booking' : ''}" 
                     draggable="true" 
                     ondragstart="dragBooking(event)" 
                     data-booking-id="${bookingId}"
                     title="${isAssigned ? 'Drag to reassign to different room' : 'Drag to assign to room'}">
                    <div class="unassigned-guest">${booking.guest_name}</div>
                    <div class="unassigned-dates">${formatDate(checkinDate)} - ${formatDate(checkoutDate)}</div>
                    <div class="unassigned-room-type">
                        ${booking.room_type || 'Any room type'} • ${guestCount} guest${guestCount !== 1 ? 's' : ''}
                        ${isAssigned ? `<br><strong>Currently: Room ${currentRoom}</strong>` : ''}
                    </div>
                </div>
            `;
        }

        // Drag and Drop Functions
        function allowDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function dragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function dragBooking(event) {
            const bookingId = event.target.closest('[data-booking-id]').dataset.bookingId;
            draggedBooking = allBookings.find(b => b.id == bookingId);
            
            event.dataTransfer.setData('text/plain', bookingId);
            event.target.closest('[data-booking-id]').classList.add('dragging');
        }

        async function dropBooking(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            const bookingId = event.dataTransfer.getData('text/plain');
            const cell = event.currentTarget;
            const roomId = cell.dataset.roomId;
            const dropDate = cell.dataset.date;
            
            // Remove dragging class
            document.querySelectorAll('.dragging').forEach(el => {
                el.classList.remove('dragging');
            });
            
            if (!draggedBooking || !roomId) return;
            
            const originalCheckinDate = draggedBooking.checkin_date || draggedBooking.check_in_date;
            const originalCheckoutDate = draggedBooking.checkout_date || draggedBooking.check_out_date;
            
            // Check if the drop date matches the booking's check-in date
            if (dropDate !== originalCheckinDate) {
                // Date mismatch detected - show edit booking modal
                showEditBookingModal(draggedBooking, roomId, dropDate);
                return;
            }
            
            // Dates match - proceed with normal assignment
            await processRoomAssignment(bookingId, roomId, originalCheckinDate, originalCheckoutDate);
        }

        async function processRoomAssignment(bookingId, roomId, checkinDate, checkoutDate) {
            // Check for conflicts in the date range
            const conflictDates = [];
            const currentDate = new Date(checkinDate);
            const endDate = new Date(checkoutDate);
            
            while (currentDate < endDate) {
                const dateStr = formatDate(currentDate);
                const existingBooking = findBookingForRoomAndDate(roomId, dateStr);
                if (existingBooking && (existingBooking.id || existingBooking.booking_id) !== bookingId) {
                    conflictDates.push(dateStr);
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            if (conflictDates.length > 0) {
                showNotification(`Cannot assign: Room ${getRoomNumber(roomId)} is occupied on ${conflictDates.join(', ')}`, 'error');
                return;
            }
            
            try {
                const response = await assignBookingToRoom(bookingId, roomId);
                
                // Update the booking data immediately to reflect the change
                if (draggedBooking) {
                    console.log(`Updating booking ${draggedBooking.guest_name} from room ${draggedBooking.room_id} to ${roomId}`);
                    
                    // Update the booking object with new room assignment
                    draggedBooking.room_id = roomId;
                    
                    // Find and update the booking in allBookings array
                    const bookingIndex = allBookings.findIndex(b => 
                        (b.id || b.booking_id) === bookingId
                    );
                    if (bookingIndex !== -1) {
                        console.log(`Found booking at index ${bookingIndex}, updating room_id to ${roomId}`);
                        allBookings[bookingIndex].room_id = roomId;
                    } else {
                        console.log(`Could not find booking with ID ${bookingId} in allBookings array`);
                    }
                }
                
                // Show appropriate message based on response
                if (response.is_reassignment) {
                    showNotification(`${response.guest_name} moved from Room ${response.old_room_number} to Room ${response.room_number}`, 'success');
                } else {
                    showNotification(`${response.guest_name} assigned to Room ${response.room_number}`, 'success');
                }
                
                // Immediately refresh calendar to show the change
                await loadCalendarData();
                
                // Clear the dragged booking reference
                draggedBooking = null;
                
            } catch (error) {
                console.error('Error assigning booking:', error);
                showNotification('Error assigning booking: ' + (error.message || 'Unknown error'), 'error');
                
                // Clear the dragged booking reference on error too
                draggedBooking = null;
            }
        }

        async function assignBookingToRoom(bookingId, roomId) {
            try {
                const response = await api.assignRoom(bookingId, roomId);
                return response;
            } catch (error) {
                throw error;
            }
        }

        // Sidebar Functions
        function toggleSidebar() {
            const sidebar = document.getElementById('unassignedSidebar');
            const toggle = document.getElementById('sidebarToggle');
            
            sidebar.classList.toggle('open');
            toggle.classList.toggle('active');
        }

        function refreshData() {
            showNotification('Refreshing calendar data...', 'info');
            loadCalendarData();
        }

        // Utility Functions
        function formatDate(date) {
            if (typeof date === 'string') {
                return date;
            }
            return date.toISOString().split('T')[0];
        }

        function getDateBefore(dateStr) {
            const date = new Date(dateStr);
            date.setDate(date.getDate() - 1);
            return formatDate(date);
        }

        function getRoomNumber(roomId) {
            const room = allRooms.find(r => r.room_id === roomId);
            return room ? room.room_number : roomId;
        }

        function showLoading() {
            document.getElementById('calendarBody').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Loading calendar data...
                </div>
            `;
        }

        function showNotification(message, type) {
            // Remove existing notifications
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i>
                ${message}
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Modal handling functions
        function showEditBookingModal(booking, roomId, dropDate) {
            const originalCheckinDate = booking.checkin_date || booking.check_in_date;
            const originalCheckoutDate = booking.checkout_date || booking.check_out_date;
            
            // Calculate booking duration
            const originalDuration = Math.ceil((new Date(originalCheckoutDate) - new Date(originalCheckinDate)) / (1000 * 60 * 60 * 24));
            
            // Calculate new checkout date based on drop date and original duration
            const newCheckinDate = dropDate;
            const newCheckoutDate = new Date(dropDate);
            newCheckoutDate.setDate(newCheckoutDate.getDate() + originalDuration);
            
            // Store pending assignment info
            pendingAssignment = {
                booking: booking,
                roomId: roomId,
                originalCheckinDate: originalCheckinDate,
                originalCheckoutDate: originalCheckoutDate,
                newCheckinDate: newCheckinDate,
                newCheckoutDate: formatDate(newCheckoutDate)
            };
            
            // Populate modal fields
            document.getElementById('editGuestName').value = booking.guest_name;
            document.getElementById('editCheckinDate').value = newCheckinDate;
            document.getElementById('editCheckoutDate').value = pendingAssignment.newCheckoutDate;
            document.getElementById('editBookingNotes').value = `Date changed from ${originalCheckinDate} - ${originalCheckoutDate} to ${newCheckinDate} - ${pendingAssignment.newCheckoutDate}`;
            
            // Show modal
            document.getElementById('editBookingModal').style.display = 'flex';
        }

        function closeEditBookingModal() {
            document.getElementById('editBookingModal').style.display = 'none';
            pendingAssignment = null;
            draggedBooking = null;
        }

        async function confirmBookingEdit() {
            if (!pendingAssignment) return;
            
            const guestName = document.getElementById('editGuestName').value?.trim();
            const newCheckinDate = document.getElementById('editCheckinDate').value?.trim();
            const newCheckoutDate = document.getElementById('editCheckoutDate').value?.trim();
            const notes = document.getElementById('editBookingNotes').value?.trim() || '';
            
            console.log('Raw form values:');
            console.log('- Guest name element:', document.getElementById('editGuestName'));
            console.log('- Guest name value:', guestName);
            console.log('- Checkin date element:', document.getElementById('editCheckinDate'));
            console.log('- Checkin date value:', newCheckinDate);
            console.log('- Checkout date element:', document.getElementById('editCheckoutDate'));
            console.log('- Checkout date value:', newCheckoutDate);
            console.log('- Notes:', notes);
            
            if (!guestName || !newCheckinDate || !newCheckoutDate) {
                showNotification('Guest name, check-in date, and check-out date are required', 'error');
                console.error('Validation failed:', { guestName, newCheckinDate, newCheckoutDate });
                return;
            }
            
            if (new Date(newCheckoutDate) <= new Date(newCheckinDate)) {
                showNotification('Check-out date must be after check-in date', 'error');
                return;
            }
            
            try {
                const bookingId = pendingAssignment.booking.id || pendingAssignment.booking.booking_id;
                
                // Debug: Log the data being sent
                const updateData = {
                    guestName: guestName,
                    checkinDate: newCheckinDate,
                    checkoutDate: newCheckoutDate,
                    notes: notes
                };
                console.log('Sending booking update data:', updateData);
                console.log('Booking ID:', bookingId);
                console.log('Form field values:', {
                    guestName: guestName,
                    newCheckinDate: newCheckinDate,
                    newCheckoutDate: newCheckoutDate,
                    notes: notes
                });
                
                // Update booking with all required fields (using backend expected field names)
                await api.updateBooking(bookingId, updateData);
                
                // Process room assignment with new dates
                await processRoomAssignment(bookingId, pendingAssignment.roomId, newCheckinDate, newCheckoutDate);
                
                showNotification(`Booking dates updated and room assigned successfully`, 'success');
                closeEditBookingModal();
                
            } catch (error) {
                console.error('Error updating booking:', error);
                showNotification('Error updating booking: ' + (error.message || 'Unknown error'), 'error');
            }
        }
    </script>
</body>
</html> 